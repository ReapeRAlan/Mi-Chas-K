{% extends "base.html" %}

{% block title %}Punto de Venta - MiChaska{% endblock %}

{% block content %}
<div class="container-fluid py-3">
    <div class="row g-3">
        <!-- Columna de Productos -->
        <div class="col-lg-8">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white py-3">
                    <h5 class="mb-0"><i class="bi bi-grid-3x3-gap-fill"></i> Productos Disponibles</h5>
                </div>
                <div class="card-body">
                    <!-- Filtros -->
                    <div class="row g-2 mb-3">
                        <div class="col-md-4">
                            <select id="categoriaFilter" class="form-select form-select-lg">
                                <option value="Todas">Todas las categorías</option>
                            </select>
                        </div>
                        <div class="col-md-8">
                            <div class="input-group input-group-lg">
                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                                <input type="text" id="searchInput" class="form-control" placeholder="Buscar producto...">
                            </div>
                        </div>
                    </div>

                    <!-- Grid de Productos -->
                    <div id="productosGrid" class="row g-3" style="max-height: calc(100vh - 300px); overflow-y: auto;">
                        <!-- Los productos se cargan dinámicamente -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Columna del Carrito -->
        <div class="col-lg-4">
            <div class="card shadow-sm sticky-top" style="top: 70px;">
                <div class="card-header bg-success text-white py-3">
                    <h5 class="mb-0"><i class="bi bi-cart-fill"></i> Carrito de Compra</h5>
                </div>
                <div class="card-body">
                    <!-- Items del Carrito -->
                    <div id="carritoItems" class="mb-3" style="max-height: 300px; overflow-y: auto;">
                        <div class="text-center text-muted py-5">
                            <i class="bi bi-cart-x fs-1"></i>
                            <p class="mt-2">Carrito vacío</p>
                        </div>
                    </div>

                    <!-- Opciones de Entrega -->
                    <div class="mb-3">
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" id="esEntregaCheck">
                            <label class="form-check-label fw-bold" for="esEntregaCheck">
                                <i class="bi bi-truck"></i> Entrega a domicilio
                            </label>
                        </div>
                        
                        <!-- Panel de Dirección (oculto por defecto) -->
                        <div id="direccionPanel" style="display: none;">
                            <div class="alert alert-info alert-sm mb-2">
                                <small><i class="bi bi-info-circle"></i> Radio de entrega: 10km</small>
                            </div>
                            
                            <!-- Buscador de Direcciones -->
                            <div class="mb-2">
                                <div class="input-group input-group-sm">
                                    <input type="text" id="buscarDireccionInput" class="form-control" 
                                           placeholder="Buscar dirección..." autocomplete="off">
                                    <button type="button" class="btn btn-outline-secondary" id="buscarDireccionBtn">
                                        <i class="bi bi-search"></i>
                                    </button>
                                </div>
                                <!-- Lista de resultados -->
                                <div id="resultadosDireccion" class="list-group mt-1" style="display: none; max-height: 200px; overflow-y: auto;"></div>
                            </div>
                            
                            <!-- Dirección seleccionada -->
                            <textarea id="direccionInput" class="form-control mb-2" rows="2" 
                                      placeholder="Dirección de entrega" readonly></textarea>
                            
                            <!-- Botones de acción -->
                            <div class="d-grid gap-2 mb-2">
                                <button type="button" class="btn btn-sm btn-outline-primary" id="usarUbicacionBtn">
                                    <i class="bi bi-geo-alt-fill"></i> Usar mi ubicación GPS
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="seleccionarMapaBtn">
                                    <i class="bi bi-map"></i> Seleccionar en mapa
                                </button>
                            </div>
                            
                            <div id="ubicacionStatus" class="mt-2"></div>
                            
                            <!-- Mapa -->
                            <div id="mapContainer" style="height: 250px; display: none;" class="mt-2 rounded border">
                                <div class="position-absolute top-0 start-0 m-2 bg-white p-2 rounded shadow-sm" style="z-index: 1000; font-size: 0.75rem;">
                                    <i class="bi bi-info-circle text-primary"></i> Haz clic en el mapa para seleccionar ubicación
                                </div>
                            </div>
                            <div id="distanciaInfo" class="text-muted small mt-2" style="display: none;"></div>
                        </div>
                    </div>

                    <hr>

                    <!-- Información del Vendedor -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label mb-0"><i class="bi bi-person"></i> Vendedor</label>
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="configurarVendedorEnTurno()" title="Establecer vendedor en turno">
                                <i class="bi bi-pin-angle-fill"></i> Fijar
                            </button>
                        </div>
                        <select id="vendedorSelect" class="form-select">
                            <option value="">Seleccionar vendedor...</option>
                        </select>
                        <div id="vendedorEnTurnoInfo" class="mt-2" style="display: none;">
                            <small class="text-success d-flex align-items-center gap-1">
                                <i class="bi bi-check-circle-fill"></i>
                                <span id="vendedorEnTurnoNombre"></span> en turno
                                <button type="button" class="btn btn-link btn-sm p-0 ms-1 text-danger" onclick="quitarVendedorEnTurno()" title="Quitar vendedor en turno">
                                    <i class="bi bi-x-circle-fill"></i>
                                </button>
                            </small>
                        </div>
                    </div>

                    <!-- Método de Pago -->
                    <div class="mb-3">
                        <label class="form-label"><i class="bi bi-credit-card"></i> Método de Pago</label>
                        <select id="metodoPagoSelect" class="form-select">
                            <option value="Efectivo">Efectivo</option>
                            <option value="Tarjeta">Tarjeta</option>
                            <option value="Transferencia">Transferencia</option>
                        </select>
                    </div>

                    <!-- Total -->
                    <div class="total-display text-center py-3 mb-3 rounded">
                        <small class="text-muted d-block mb-1">TOTAL</small>
                        <h2 class="mb-0 fw-bold" id="totalDisplay">$0.00</h2>
                    </div>

                    <!-- Botones de Acción -->
                    <div class="d-grid gap-2">
                        <button id="procesarVentaBtn" class="btn btn-success btn-lg" disabled>
                            <i class="bi bi-check-circle-fill"></i> Procesar Venta
                        </button>
                        <button id="limpiarCarritoBtn" class="btn btn-outline-danger">
                            <i class="bi bi-trash"></i> Limpiar Carrito
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirmación de Venta -->
<div class="modal fade" id="ventaExitosaModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="bi bi-check-circle-fill"></i> Venta Procesada</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center py-4">
                <i class="bi bi-check-circle text-success" style="font-size: 4rem;"></i>
                <h4 class="mt-3">¡Venta exitosa!</h4>
                <p class="mb-3">Venta #<span id="ventaIdDisplay"></span></p>
                <h3 class="text-success fw-bold mb-3">$<span id="ventaTotalDisplay"></span></h3>
                <div id="entregaInfoDisplay"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="descargarTicketBtn">
                    <i class="bi bi-file-pdf"></i> Descargar Ticket
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/pos.js') }}"></script>
{% endblock %}
